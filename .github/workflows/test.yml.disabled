name: Test Fabric Archive Bot

on:
  push:
    branches: [main, jdb/FABv2dev]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PowerShell
        uses: azure/powershell@v1
        with:
          azPSVersion: "latest"
          inlineScript: |
            # Verify PowerShell version
            $PSVersionTable.PSVersion

      - name: Install Pester
        shell: pwsh
        run: |
          if (-not (Get-Module -Name Pester -ListAvailable)) {
            Install-Module -Name Pester -Scope CurrentUser -Force -SkipPublisherCheck
          }
          Import-Module Pester

      - name: Run Unit Tests
        shell: pwsh
        run: |
          .\tests\Invoke-Tests.ps1 -TestType Unit -OutputFormat JUnitXml -OutputFile unit-test-results.xml

      - name: Run Integration Tests
        shell: pwsh
        run: |
          .\tests\Invoke-Tests.ps1 -TestType Integration -OutputFormat JUnitXml -OutputFile integration-test-results.xml

      - name: Run All Tests with Coverage
        shell: pwsh
        run: |
          .\tests\Invoke-Tests.ps1 -Coverage -OutputFormat JUnitXml -OutputFile all-test-results.xml

      - name: Publish Test Results
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: Pester Test Results
          path: "*-test-results.xml"
          reporter: java-junit

      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: coverage-reports
          path: |
            tests/coverage.xml
            *-test-results.xml
          retention-days: 30
